{% extends 'base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/trip.css') }}" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="{{ url_for('static', filename='js/index.js') }}"></script>

{% endblock %}

{% block content %}
<div id="formPopupOverlay" style="display:none;"></div>
<div id="formPopupModal" style="display:none;">
  <div id="formPopupContent">
    {% include 'main/edit_trip_form.html' %}
  </div>
  <button id="closeFormPopup">Close</button>
</div>

<div class="single_trip_container">
  <div class="container">

    {% set max_travelers = trip.max_travelers or 999999 %}
    {% set min_age = trip.min_age or 0 %}
    {% set max_age = trip.max_age or 999999 %}
    <div class="top-container">
      <div class="back-arrow">
        <a href="{{ url_for('main.index') }}">
          <h2>← Main Page</h2>
        </a>
      </div>
      <div class="trip-photo-container">
        <img class="trip-photo" id="trip-bg" src="{{ url_for('static', filename='resources/' ~ trip.image) }}"
          alt="{{ trip.title }}">
        <div class="trip-title-wrapper">
          <h2>{{ trip.title }}</h2>
          <p>Created {{ trip.timestamp|time_ago }} by
            <a href="{{ url_for('main.profile', user_id=trip.creator.id) }}">
              {{ trip.creator.name }}
            </a>
          </p>
          <p class="trip-description">{{ trip.description }}</p>
        </div>
        <div class="details">
          <div class="trip-info">

            <p class="trip-origin">
              Origin: <span class="criteria">{{ trip.origin }}</span>
              {% if trip.origin_finalized %}
                <img src="{{ url_for('static', filename='resources/finalized.png') }}" class="lock-icon" alt="Finalized">
              {% endif %}
            </p>

            <p class="trip-destinations">
              Destination(s): <span class="criteria">{{ trip.destinations.replace(',', ', ') }}</span>
              {% if trip.destinations_finalized %}
                <img src="{{ url_for('static', filename='resources/finalized.png') }}" class="lock-icon" alt="Finalized">
              {% endif %}
            </p>

            {% if max_travelers != 999999 and max_travelers > 0 %}
              <p>
                Member Capacity: 
                <span class="criteria {% if trip.participants|length >= max_travelers %}red{% endif %}">
                  {{ trip.participants|length }}/{{ max_travelers }}
                </span>
                {% if trip.participants|length < max_travelers %}
                  <span class="open-members-popup">(view)</span>
                {% endif %}
              </p>
            {% endif %}

            {% if not (min_age == 0 and max_age == 999999) %}
              <p>
                Age range: 
                <span class="criteria {% if current_user.age < min_age or current_user.age > max_age %}red{% endif %}">
                  {{ min_age }} to {{ max_age }} years old
                </span>
                {% if trip.age_range_finalized %}
                  <img src="{{ url_for('static', filename='resources/finalized.png') }}" class="lock-icon" alt="Finalized">
                {% endif %}
              </p>
            {% else %}
              <p>Age range: <span class="criteria">N/A</span></p>
            {% endif %}

            {% if trip.budget and trip.budget > 0 %}
              <p>
                Trip Budget: <span class="criteria">€{{ trip.budget }}</span>
                {% if trip.budget_finalized %}
                  <img src="{{ url_for('static', filename='resources/finalized.png') }}" class="lock-icon" alt="Finalized">
                {% endif %}
              </p>
            {% endif %}

            {% set valid_uni = True %}

                {% if trip.university %}
                    {% if trip.university == 'home_only' %}
                        {% set allowed_uni = trip.creator.home_uni %}
                        {% set valid_uni = (current_user.home_uni == trip.creator.home_uni or
                                            current_user.visiting_uni == trip.creator.home_uni) %}
                        <p>University Restriction: {{ allowed_uni }}</p>

                    {% elif trip.university == 'visiting_only' %}
                        {% set allowed_uni = trip.creator.visiting_uni %}
                        {% set valid_uni = (current_user.home_uni == trip.creator.visiting_uni or
                                            current_user.visiting_uni == trip.creator.visiting_uni) %}
                        <p>University Restriction: {{ allowed_uni }}</p>

                    {% elif trip.university == 'both' %}
                        {% set allowed_uni_1 = trip.creator.home_uni %}
                        {% set allowed_uni_2 = trip.creator.visiting_uni %}
                        {% set valid_uni = (
                            current_user.home_uni in [allowed_uni_1, allowed_uni_2] or
                            current_user.visiting_uni in [allowed_uni_1, allowed_uni_2]
                        ) %}
                        <p>University Restriction: {{ allowed_uni_1 }} or {{ allowed_uni_2 }}</p>
                    {% endif %}
                {% else %}
                    <p>University Restriction: None</p>
                {% endif %}

            <p>
              Planned Date Range: 
              <span class="criteria">{{ trip.start_date.strftime('%B %d, %Y') }} to {{ trip.end_date.strftime('%B %d, %Y') }}</span>
              {% if trip.dates_finalized %}
                <img src="{{ url_for('static', filename='resources/finalized.png') }}" class="lock-icon" alt="Finalized">
              {% endif %}
            </p>

            {% set status_map = {0: 'Open for joining', 1: 'Open (approval required)', 2: 'Closed', 3: 'Finalized',
                4: 'Cancelled'} %}
                {% if trip.status == 0 %}
                <p>Status:<span class="criteria green"> {{ status_map[trip.status] }}</span></p>
                {% elif trip.status == 1 %}
                <p>Status:<span class="criteria yellow"> {{ status_map[trip.status] }}</span></p>
                {% else %}
                <p>Status:<span class="criteria red"> {{ status_map[trip.status] }}</span></p>
                {% endif %}
                {% set trip_readonly = trip.status in [2, 3, 4] %}
          </div>



          <div class="button-container">
            {% if current_user.is_editor_for(trip) %}
            {% if not (trip.status in [2, 3, 4]) %}
            <button class="trip-button" id="openFormPopup" fdprocessedid="vywhbj">Modify Trip</button>
            {% endif %}
            {% if trip.status == 1 %}
            <button class="trip-button" id="open-join-requests-popup">View Join Requests</button>
            {% endif %}
            {% endif %}
            {% if (trip.participants|length < max_travelers) and (current_user.age>= min_age) and (current_user.age <= max_age) and valid_uni %} 
              {% if not already_joined %} {% if trip.status==0 %} <form
                action="{{ url_for('main.join_trip', trip_id=trip.id) }}" method="POST">
                <button type="submit" class="trip-button">
                  Join Trip
                </button>
                </form>
                {% elif trip.status == 1 %}
                {% if not current_user.has_pending_request_for(trip) %}
                <form action="{{ url_for('main.request_join_trip', trip_id=trip.id) }}" method="POST">
                  <button type="submit" class="trip-button">
                    Request to Join Trip
                  </button>
                </form>
                {% else %}
                <form action="{{ url_for('main.cancel_join_request', trip_id=trip.id) }}" method="POST">
                  <button type="submit" class="trip-button">
                    Cancel Join Request
                  </button>
                </form>
                {% endif %}
                {% endif %}
                {% elif current_user.is_editor_for(trip) == False or trip.num_editors() > 1 %}
                <form action="{{ url_for('main.leave_trip', trip_id=trip.id) }}" method="POST">
                  <button type="submit" class="trip-button">Leave Trip</button>
                </form>
                {% endif %}
                {% else %}
                {% if not already_joined %}
                <p><i>You're not eligible to join this trip at the moment.</i></p>
                {% endif %}
                {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

    <div id="members-popup" class="popup">
      <div class="popup-content">
        <span class="close">&times;</span>
        <h2>Current Trip Members</h2>
        <div class="participant-list">
          {% for participant in trip.participants %}
          <div class="participant">
            <a class="single-participant" href="{{ url_for('main.profile', user_id=participant.id) }}">
              <img src="{{ url_for('static', filename='resources/' ~ participant.profile_pic) }}" class="header-icon" />
              <span>{{ participant.name }}</span>
            </a>

            <span class="participant-role">
              {% if participant.is_editor_for(trip) %}
              <span class="editor-badge">Editor</span>
              {% elif current_user.is_editor_for(trip) %}
              <form method="POST"
                action="{{ url_for('main.make_editor', trip_id=trip.id, participant_id=participant.id) }}">
                <button type="submit" class="make-editor-btn">Make Editor</button>
              </form>
              {% else %}
              <span class="member-badge">Member</span>
              {% endif %}
            </span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div id="join-requests-popup" class="popup">
      <div class="popup-content">
        <span class="close">&times;</span>
        <h2>Active Join Requests</h2>
        <div class="join-request-list">
          {% if join_requests|length == 0 %}
          <p>No active join requests.</p>
          {% endif %}
          {% for req, user in join_requests %}
          <div class="join-request">
            <a class="single-participant" href="{{ url_for('main.profile', user_id=req.user_id) }}">
              <img src="{{ url_for('static', filename='resources/' ~ user.profile_pic) }}" class="header-icon" />
              <span>{{ user.name }}</span>
            </a>

            <div class="buttons-container">
              <form method="POST"
                action="{{ url_for('main.update_join_request', trip_id=trip.id, requesting_user_id=req.user_id) }}">
                <button type="submit" class="approve-btn" name="approval_status" value="approve">Approve</button>
                <button type="submit" class="deny-btn" name="approval_status" value="deny">Deny</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
      {% for category, message in messages %}
      <li class="{{ category }}">{{ message }}</li>
      {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    {% if not (trip.participants|length >= max_travelers or current_user.age < min_age or current_user.age > max_age)%}
      {% if already_joined %}
      <p class="member-specifics">You are an active member of this trip.</p>
      {% if current_user.is_editor_for(trip) %}
      <p class="member-specifics membership-level">Membership Level: Editor</p>
      {% else %}
      <p class="member-specifics membership-level">Membership Level: Member</p>
      {% endif %}
      {% endif %}
      {% endif %}

      <div class="page-contents">
        {% if already_joined %}
        <div id="message-board-area" class="message-board-area">
          <div class="page-contents-header">
            <h2>Message Board</h2>
            <h4>Chat With Your Tripmates</h4>
          </div>

          <div class="forums">
            <div class="forum-tabs">
              {% for topic in forum_topics %}
              {% if topic==active_topic %}
              <a class="topic active-topic"
                href="{{ url_for('main.trip', trip_id=trip.id, forum_topic=topic) }}#message-board-area">{{ topic
                }}</a>
              {% else %}
              <a class="topic"
                href="{{ url_for('main.trip', trip_id=trip.id, forum_topic=topic) }}#message-board-area">{{ topic
                }}</a>
              {% endif %}
              {% endfor %}
              <button id="new-topic-button">+</button>
              <div class="tab-spacer"></div>
            </div>
            <div class="chat-wrapper">
              <div class="messages-container">
                {% if active_forum_messages %}
                {% for message in active_forum_messages %}
                {% if message.user_id==current_user.id %}
                <div class="message-container sent-message">
                  {% else %}
                  <div class="message-container received-message">
                    {% endif %}
                    <div class="message-header">
                      <a class="message-header" href="{{ url_for('main.profile', user_id=message.user.id) }}"
                        style="text-decoration: none; color: inherit;">
                        <img src="{{ url_for('static', filename='resources/' ~ message.user.profile_pic) }}"
                          alt="Profile" class="header-icon" />
                        <div class="message-info">
                          <p><strong>{{ message.user.name }}</strong></p>
                          <p>{{ message.timestamp.strftime('%b %d, %Y, %H:%M') }}</p>
                        </div>
                      </a>
                    </div>
                    <p>{{ message.content }}</p>
                  </div>
                  {% endfor %}
                  {% else %}
                  <p>Write the first message for this forum...</p>
                  {% endif %}
                </div>
              </div>
              
              
              <form {% if not trip_readonly %} action="{{ url_for('main.new_message', trip_id=trip.id) }}#message-board-area" method="post"{% endif %}>
                <input type="hidden" name="forum_topic" value="{{ active_topic }}" id="forum-topic-input"
                  data-active-topic="{{ active_topic }}">
                <div id="new-forum-topic-input" style="display: none">
                  <label>Name your new forum topic:</label>
                  <input type="text" name="new_forum_topic" placeholder="Enter new forum topic name..." maxlength="64">
                  <button type="button" id="cancel-new-forum-topic">Cancel</button>
                </div>

                <div class="send-message">
                  <textarea class="send-message-area" maxlength="200" name="message-content"
                    {% if not trip_readonly %}
                      placeholder="What's on your mind?"
                    {% else %}
                      disabled placeholder="Can't send new messages in an archivised trip"
                    {% endif %}
                  ></textarea>
                  <button class="send-message-button"{% if trip_readonly %}disabled{%endif%} type="submit">Send</button>
                </div>
              </form>
            </div>
          </div>

          <div class="calendar-wrapper">
            <div class="page-contents-header">
              <h2>Event Calendar</h2>
              <h4>See What Events/Meetups Are Scheduled For This Trip</h4>
            </div>
            <div id="calendar" data-readonly="{{trip_readonly}}"></div>
          </div>

          <div id="meetup-area">
            <div class="meetup-area-content">
              <h3>Create a Meetup...</h3>
              <form id="meetup-form">
                <div class="form-group">
                  <label>Location:</label>
                  <input type="text" name="location" required placeholder="e.g., School library or Zoom call">
                </div>

                <div class="form-group">
                  <label>Date:</label>
                  <input type="date" name="date" id="meetup-date" required>
                </div>

                <div class="form-group">
                  <label>Time:</label>
                  <input type="time" name="time" required>
                </div>

                <div class="form-group">
                  <label>Link (optional):</label>
                  <input type="text" name="link" placeholder="Add a link if needed...">
                  <small>Add a link for online meetings, such as Zoom, Google Meet, etc.</small>
                </div>

                <div class="form-group">
                  <label>Description:</label>
                  <textarea name="description" rows="5" maxlength="1024" required
                    placeholder="Describe your meetup/event..."></textarea>
                </div>

                <div class="meetup-area-buttons">
                  <button type="button" id="cancel-meetup-creation-button">Cancel</button>
                  <button type="submit">Create Meetup</button>
                </div>
              </form>
            </div>
          </div>

          <div id="existing-meetup-popup" class="existing-meetup-popup">
            <div class="existing-meetup-popup-content">
              <h3>Meetup Details</h3>
              <br>
              <p><strong>Location: </strong><span id="detail-location"></span></p>
              <p><strong>Start date: </strong><span id="detail-start"></span></p>
              <p><strong>Description: </strong><span id="detail-description"></span></p>
              <p><strong>Link: </strong><a id="detail-link" href="#" target="_blank"></a></p>

              <div class="existing-meetup-popup-buttons">
                <button id="open-link" style="display:none;">Open Link</button>
                <button id="delete-event">Delete Event</button>
                <button id="close-event">Close</button>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endblock %}

        {% block scripts %}
        <script src="{{ url_for('static', filename='travel-together.js') }}"></script>
        <script src="{{ url_for('static', filename='js/trip.js') }}"></script>
        {% if already_joined %}
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"></script>
        <script>
          var initialDateValue = "{{ trip.start_date.strftime('%Y-%m-%d') }}";
          var tripId = "{{ trip.id }}";
        </script>
        <script src="{{ url_for('static', filename='calendar.js') }}"></script>
        {% endif %}
        {% endblock %}